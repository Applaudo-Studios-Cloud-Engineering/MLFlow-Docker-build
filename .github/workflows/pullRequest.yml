name: CI
on:
  push:
    branches:
      - test
jobs:
  pull-request:
    name: Open PR to main
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        name: checkout

      - name: Run ID
        id: run_id
        run: echo "id=$(sed "4q;d" build_data.txt)" >> $GITHUB_OUTPUT

      - name: Run ID output
        run: echo ${{ steps.run_id.outputs.id }}

      - id: auth
        uses: google-github-actions/auth@v0
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Use gcloud CLI
        env:
          BUCKET: ${{ secrets.BUCKET_NAME }}
          LOCATION_ROOT: ${{ secrets.LOCATION_ROOT }}
          EXPERIMENT_ID: ${{ secrets.EXPERIMENT_ID }}
        run: gsutil -m cp -r "gs://$BUCKET/$LOCATION_ROOT/$EXPERIMENT_ID/${{ steps.run_id.outputs.id }}/artifacts/model/*" ./docker_resources/temp_artifacts/

      - name: Check output
        env:
          RELEASE_VERSION: ${{ steps.vars.outputs.tag }}
        run: |
          echo $RELEASE_VERSION
          echo ${{ steps.vars.outputs.tag }}
          ls ./docker_resources/temp_artifacts/

      # - uses: repo-sync/pull-request@v2
      #   name: pull-request
      #   with:
      #     destination_branch: "main"
      #     pr_title: "Pulling ${{ github.ref }} into main"
      #     pr_body: "ðŸ‘‘ *An automated PR*"
      #     pr_reviewer: "mdeleon"
      #     pr_draft: true
      #     github_token: ${{ secrets.TOKEN_REPOSITORY }}
      #test
